// Power Query M script version of spool_trace.sql
// Provides parameterized JobNo and SpoolNo.
// To use in Excel / Power BI: paste into Advanced Editor, or split parameters out to UI parameters.

let
    // --- Parameters (edit as needed) ---
    JobNo   = "511267",    // e.g. "505976"; set to null for all jobs
    SpoolNo = null,         // e.g. 12; set to null for all spools in job

    // Helper to render SpoolNo value in DECLARE (NULL or integer)
    SpoolNoLiteral = if SpoolNo = null then "NULL" else Number.ToText(SpoolNo),

    // Construct SQL query text using #(lf) for line feeds
    SqlQuery = "-- Spool trace across production: Spool -> FlatRolls -> Brick (SFG) -> Rewind Bricks -> Press Rolls#(lf)-- Extended with customer packaging (Box/Pallet) and operator + machine lineage#(lf)-- Adjust @JobNo and @SpoolNo, then execute.#(lf)#(lf)SET NOCOUNT ON;#(lf)SET QUOTED_IDENTIFIER ON;#(lf)#(lf)DECLARE @JobNo    nvarchar(6) = N'" & JobNo & "';#(lf)DECLARE @SpoolNo  int         = " & SpoolNoLiteral & ";#(lf)#(lf);WITH SpoolSel AS (#(lf)
  SELECT s.spoolID, s.spoolNo, s.sku__ref AS SpoolSKU, s.Qty AS SpoolQty, s.Weight AS SpoolWeight,#(lf)         s.weightPer20K, s.flatRollQty, s.flatRollDiff, s.lastModified AS SpoolLastModified,#(lf)         sj.spoolJobID, sj.ord__ref AS JobNo#(lf)  FROM dbo.spool AS s#(lf)  INNER JOIN dbo.spoolJob AS sj#(lf)    ON sj.spoolJobID = s.spoolJobID#(lf)  WHERE (@JobNo   IS NULL OR sj.ord__ref = @JobNo)#(lf)    AND (@SpoolNo IS NULL OR s.spoolNo  = @SpoolNo)#(lf)), FRS AS (#(lf)  SELECT frs.flatRollSpoolID, frs.spoolID, frs.flatRollID, frs.brickID, frs.lastModified AS FlatRollAddedToSpool#(lf)  FROM dbo.flatRollSpool AS frs#(lf)), FR AS (#(lf)  SELECT fr.flatRollID, fr.brickID, fr.flatRollNo, fr.operatorID, fr.spoolerID, fr.lastModified AS FlatRollLastModified#(lf)  FROM dbo.flatRoll AS fr#(lf)), SPOOL AS (#(lf)  SELECT spl.spoolerID, spl.spooler AS SpoolerMachine#(lf)  FROM dbo.spooler AS spl#(lf)), BR AS (#(lf)  SELECT b.brickID, b.spoolJobID, b.brickNo, b.sku__ref AS BrickSFG, b.flatRolls, b.rewindBrickNo, b.lastModified AS BrickLastModified#(lf)  FROM dbo.brick AS b#(lf)), RB AS (#(lf)  -- Link bricks (created SFG) to rewind bricks within the same job to keep lineage precise#(lf)  SELECT rb.stlST_RewindBrickID, rb.created_hlf__ref AS BrickSFG, rb.ord__ref AS JobNo,#(lf)         rb.rewindBrickNo AS RewindBrickNo, rb.goodLabels, rb.grossLabels, rb.labelsPerRow,#(lf)         rb.goodCount, rb.qaHold, rb.closed, rb.lastModified AS RewindBrickLastModified,#(lf)         rb.wn___ref AS RewindOperatorRef#(lf)  FROM dbo.stlST_RewindBrick AS rb#(lf)), RWSFG AS (#(lf)  -- Resolve rewind machine via the SFG creation record#(lf)  SELECT hlf.hlf__ref, hlf.wp___ref AS RewindMachineRef#(lf)  FROM dbo.hlfvrd__ AS hlf#(lf)), RWMACH AS (#(lf)  SELECT wp.wp___ref, wp.wp_naam_ AS RewindMachineName#(lf)  FROM dbo.werkpo__ AS wp#(lf)), PRJ AS (#(lf)  SELECT prx.stlST_RewindBrickID, prx.stlST_PressRollID, prx.goodLabels AS PRX_GoodLabels,#(lf)         prx.grossLabels AS PRX_GrossLabels, prx.goodCount AS PRX_GoodCount, prx.wn___ref AS PressJunctionOperatorRef#(lf)  FROM dbo.stlST_PressRollXstlST_RewindBrick AS prx#(lf)), PR AS (#(lf)  SELECT pr.stlST_PressRollID, pr.hlf__ref AS PressRollSFG, pr.inh__oms AS PressRollDesc,#(lf)         pr.ord__ref AS JobNo, pr.aantm_in AS PressSFGGoodFt, pr.goodCount AS PressGoodCount,#(lf)         pr.rewindGoodLabels, pr.rewindWasteLabels, pr.badRowsWasteLabels, pr.flatrolls,#(lf)         pr.etiket_h, pr.tssnaf_h, pr.lastModified AS PressRollLastModified#(lf)  FROM dbo.stlST_PressRoll AS pr#(lf)), PRSFG AS (#(lf)  -- Get the press operator who created the SFG (from hlfvrd__)#(lf)  SELECT hlf.hlf__ref, hlf.wn___ref AS PressCreatorRef, hlf.wp___ref AS PressMachineRef#(lf)  FROM dbo.hlfvrd__ AS hlf#(lf)), PRMACH AS (#(lf)  SELECT wp.wp___ref, wp.wp_naam_ AS PressMachineName#(lf)  FROM dbo.werkpo__ AS wp#(lf)), SKU AS (#(lf)  -- Link finished-good SKU (SpoolSKU) to box/pallet#(lf)  SELECT sk.sku__ref, sk.ord__ref, sk.box__ref, sk.pal__ref, sk.vak__ref, #(lf)         sk.aant__ex AS SkuQty, sk.crea_dat AS SkuCreated, sk.inhoud01, sk.volgnr__#(lf)  FROM dbo.afgsku__ AS sk#(lf)), BX AS (#(lf)  SELECT bx.box__ref, bx.pal__ref, bx.ord__ref, bx.crea_dat AS BoxCreated#(lf)  FROM dbo.afgbox__ AS bx#(lf)), PAL AS (#(lf)  SELECT pal.pal__ref, pal.pal__oms AS PalletDesc, pal.datum___ AS PalletDate, pal.vak__ref AS PalletLocation#(lf)  FROM dbo.palet___ AS pal#(lf)), OPR AS (#(lf)  -- Spooling operators (flatRoll)#(lf)  SELECT o.operatorID, o.operator AS OperatorName#(lf)  FROM dbo.operator AS o#(lf)), WRK AS (#(lf)  -- CERM operators (rewind, press) - werknm__ table#(lf)  SELECT w.wn___ref, LTRIM(RTRIM(w.wn_vnaam)) + ' ' + LTRIM(RTRIM(w.wn_naam_)) AS WorkerName#(lf)  FROM dbo.werknm__ AS w#(lf))#(lf)SELECT#(lf)  ss.JobNo,#(lf)  ss.spoolNo AS SpoolNo,#(lf)  ss.SpoolSKU,#(lf)  ss.SpoolQty,#(lf)  ss.SpoolWeight,#(lf)  ss.weightPer20K,#(lf)  ss.flatRollQty,#(lf)  ss.flatRollDiff,#(lf)  ss.SpoolLastModified,#(lf)#(lf)  fr.flatRollNo,#(lf)  fr.FlatRollLastModified,#(lf)  spool.SpoolerMachine,#(lf)  opr.OperatorName AS SpoolingOperator,#(lf)#(lf)  br.brickNo AS BrickNo,#(lf)  br.BrickSFG,#(lf)  br.rewindBrickNo,#(lf)  br.flatRolls AS BrickFlatRolls,#(lf)  br.BrickLastModified,#(lf)#(lf)  rb.RewindBrickNo,#(lf)  rb.goodLabels      AS RewindBrickGoodLabels,#(lf)  rb.grossLabels     AS RewindBrickGrossLabels,#(lf)  rb.labelsPerRow    AS RewindBrickLabelsPerRow,#(lf)  rb.goodCount       AS RewindBrickGoodCount,#(lf)  rb.qaHold          AS RewindBrickQAHold,#(lf)  rb.closed          AS RewindBrickClosed,#(lf)  rb.RewindBrickLastModified,#(lf)  rwmach.RewindMachineName,#(lf)  wrk_rb.WorkerName  AS RewindOperator,#(lf)#(lf)  pr.PressRollSFG,#(lf)  pr.PressRollDesc,#(lf)  pr.PressGoodCount,#(lf)  pr.PressSFGGoodFt,#(lf)  pr.rewindGoodLabels AS PressRewindGoodLabels,#(lf)  pr.rewindWasteLabels AS PressRewindWasteLabels,#(lf)  pr.badRowsWasteLabels AS PressBadRowsWasteLabels,#(lf)  pr.flatrolls          AS PressFlatRolls,#(lf)  pr.etiket_h,#(lf)  pr.tssnaf_h,#(lf)  pr.PressRollLastModified,#(lf)  prmach.PressMachineName,#(lf)  wrk_pr.WorkerName AS PressOperator,#(lf)#(lf)  -- Customer packaging (FG SKU, Box, Pallet)#(lf)  sku.sku__ref AS FG_SKU,#(lf)  sku.volgnr__ AS FG_SeqNumber,#(lf)  sku.SkuQty AS FG_Qty,#(lf)  sku.inhoud01 AS FG_SpoolNumber,#(lf)  sku.SkuCreated,#(lf)  bx.box__ref AS BoxRef,#(lf)  bx.BoxCreated,#(lf)  pal.pal__ref AS PalletRef,#(lf)  pal.PalletDesc,#(lf)  pal.PalletDate,#(lf)  pal.PalletLocation,#(lf)#(lf)  frs.flatRollSpoolID,#(lf)  frs.FlatRollAddedToSpool#(lf)FROM SpoolSel AS ss#(lf)INNER JOIN FRS AS frs#(lf)  ON frs.spoolID = ss.spoolID#(lf)INNER JOIN FR AS fr#(lf)  ON fr.flatRollID = frs.flatRollID#(lf)INNER JOIN BR AS br#(lf)  ON br.brickID = frs.brickID#(lf)-- Machine and operator lookups#(lf)LEFT JOIN SPOOL AS spool#(lf)  ON spool.spoolerID = fr.spoolerID#(lf)LEFT JOIN OPR AS opr#(lf)  ON opr.operatorID = fr.operatorID#(lf)LEFT JOIN RB AS rb#(lf)  ON rb.BrickSFG = br.BrickSFG#(lf) AND rb.JobNo    = ss.JobNo#(lf)LEFT JOIN RWSFG AS rwsfg#(lf)  ON rwsfg.hlf__ref = rb.BrickSFG#(lf)LEFT JOIN RWMACH AS rwmach#(lf)  ON rwmach.wp___ref = rwsfg.RewindMachineRef#(lf)LEFT JOIN WRK AS wrk_rb#(lf)  ON wrk_rb.wn___ref = rb.RewindOperatorRef#(lf)LEFT JOIN PRJ AS prj#(lf)  ON prj.stlST_RewindBrickID = rb.stlST_RewindBrickID#(lf)LEFT JOIN PR AS pr#(lf)  ON pr.stlST_PressRollID = prj.stlST_PressRollID#(lf)LEFT JOIN PRSFG AS prsfg#(lf)  ON prsfg.hlf__ref = pr.PressRollSFG#(lf)LEFT JOIN PRMACH AS prmach#(lf)  ON prmach.wp___ref = prsfg.PressMachineRef#(lf)LEFT JOIN WRK AS wrk_pr#(lf)  ON wrk_pr.wn___ref = prsfg.PressCreatorRef#(lf)-- Link to finished-good (spool FG SKU) then to box and pallet#(lf)LEFT JOIN SKU AS sku#(lf)  ON sku.sku__ref = ss.SpoolSKU#(lf) AND sku.ord__ref = ss.JobNo#(lf)LEFT JOIN BX AS bx#(lf)  ON bx.box__ref   = sku.box__ref#(lf) AND bx.ord__ref   = ss.JobNo#(lf)LEFT JOIN PAL AS pal#(lf)  ON pal.pal__ref  = bx.pal__ref#(lf)ORDER BY ss.JobNo, ss.spoolNo, frs.flatRollSpoolID;",

    // Connect using Sql.Database with Query parameter (NOT Value.NativeQuery)
    Source = Sql.Database("STL-SQL1\CRMDB", "sqlb00", [Query=SqlQuery])

in
    Source
