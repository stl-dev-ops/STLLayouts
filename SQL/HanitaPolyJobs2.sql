WITH ConsumptionJIDs AS (
    SELECT DISTINCT
        stobew__.ord__ref,
        stobew__.art__ref AS materialID,
        artiky__.lev__ref AS supplierID,
        artiky__.art__rpn AS materialKeyword
    FROM stobew__
    JOIN bstlyn__
        ON bstlyn__.ord__ref = stobew__.ord__ref
    JOIN afgart__
        ON afgart__.afg__ref = bstlyn__.afg__ref
    JOIN artiky__
        ON artiky__.art__ref = afgart__.art__ref
    WHERE stobew__.soort___ = '3'
        AND stobew__.art__ref IN (
            '105496','105497','105498','105531','105185','105550','105579','103878',
            '106091','105619','106363','106467','106130','106185','105116','106079',
            '106901','106947','107129','106974','106641','106737','106970','107006',
            '107071','107073','107078','106824','106231','105968','107092','106948',
            '106973','106858','106877','106878','100766','103047','104513','103312',
            '104215','103419','103587','106200','106260','105669','105670','103715',
            '105069','105101','105102','105186','105507','105877','106064','106128',
            '106189','106381','106398','106425','106470','106524','106605','106682',
            '106729','105705','105882','105883','106081','106116','105104','105385',
            '105857','105861','105952','105953','106110','106111','106136','106137',
            '106138','106146','106157','106327','106328','106523','106721','106722',
            '105145','105475','106502','106949','105144','106326','106383','106433',
            '106530','106972','106046','106047','106048','106049','106071','103213',
            '103724','103711','105075','103949','104367','101075','103608','103807',
            '104727','100291','105113','104663','104664','105407','104990','104912',
            '105315','105532','103072','106325','106787','105616','104215','104907',
            '102793')
        ),
JIDDetails AS (
    SELECT DISTINCT 
        bstlyn__.vrz__dat AS shipDate,
        bstlyn__.ord__ref AS JobID,
        bstlyn__.kla__ref AS CustomerID,
        bstlyn__.kla__rpn AS CustomerKeyword,
        bstlyn__.afg__ref AS ProductID,
        bstlyn__.afg_oms1 AS ProductDescription,
        bstlyn__.l_aantal AS DeliveredQuantity,
        afgart__.art__ref AS MaterialID,
        artiky__.art__rpn AS MaterialKeyword,
        CASE
            WHEN ConsumptionJIDs.materialID IN (
                '101075','103608','103807','104727','100291','105113','104663','104664',
                '105407','104990','104912','105315','105532','103072','106325','106787',
                '105616','104215','104907','102793'
            ) THEN 'POLYM-001'
            WHEN ConsumptionJIDs.materialID IN (
                '105496','105497','105498','105531','105185','105550','105579','103878',
                '106091','105619','106363','106467','106130','106185','105116','106079',
                '106901','106947','107129','106974','106641','106737','106970','107006',
                '107071','107073','107078','106824','106231','105968','107092','106948',
                '106973','106858','106877','106878','100766','103047','104513','103312',
                '104215','103419','103587','106200','106260','105669','105670','103715',
                '105069','105101','105102','105186','105507','105877','106064','106128',
                '106189','106381','106398','106425','106470','106524','106605','106682',
                '106729','105705','105882','105883','106081','106116','105104','105385',
                '105857','105861','105952','105953','106110','106111','106136','106137',
                '106138','106146','106157','106327','106328','106523','106721','106722',
                '105145','105475','106502','106949','105144','106326','106383','106433',
                '106530','106972','106046','106047','106048','106049','106071','103213',
                '103724','103711','105075','103949','104367'
            ) THEN 'HANI-001'
            ELSE NULL
        END AS SupplierKeyword
    FROM ConsumptionJIDs
    LEFT JOIN bstlyn__
        ON bstlyn__.ord__ref = ConsumptionJIDs.ord__ref
    LEFT JOIN afgart__
        ON afgart__.afg__ref = bstlyn__.afg__ref
    LEFT JOIN artiky__
        ON artiky__.art__ref = afgart__.art__ref
)
SELECT *
FROM JIDDetails
WHERE SupplierKeyword IS NOT NULL
    AND DeliveredQuantity >= 0
    AND ProductDescription LIKE '%peel%'
ORDER BY shipDate DESC;